
'''
Chris Langlo and Alex Salmon 10/07/2015
This is a script to take ARFS input and create batch files.

Abbrevs:
lps     = lines per strip;
lbss    = lines between strip start;
NCCrows = # NCC rows to ignore;
NCCcols = # NCC cols to ignore;
thresh  = strip NCC threshold;
overlap = min overlap for cropping;
dmbpath = file path for the dmb files to be edited;

Last edit: 10/07/2015
'''
import wx, pprint, cPickle, os

#Put path containing batch files to be edited below, double each backslash in the path
dmbpath = '\\\\aoip-server\\remote-project-folders\\Chris_Langlo\\PythonScripts\\dmb_test\\'

#Define the parameters for the new batch files
lps         = 34
lbss        = 17
NCCrows     = 20
NCCcols     = 125
thresh      = 0.95
overlap     = 5
maxdisplace = 210
appendtxt   = "_fixed"
#--------------------------------------------------------

#Function to get a list of the dmb files in the given path
def getFileList(path,extfilt):
    files = []
    pathcontents=os.listdir(path)
        
    for f in pathcontents:
        filen,ext=os.path.splitext(f)
        if ext=='.dmb':
            files.append(f)                

    return files

#read in list of files
filelist = getFileList(dmbpath,'.dmb')
numfiles = len(filelist)

#Loop through each file in the list, for each load the pickle
for f in filelist:
    print f
    fid=open(dmbpath+f,'r')
    pick = cPickle.load(fid)
    fid.close()
#Create a new file suffix to reflect the different number of lps and lbss
    indx = f.find("lps",0,len(f))
    indx -= 1
    newname = f[0:indx]
## addon = the characters to append to the file name just before the .dmb extension
    addon = "lps_"+str(lps)+"_lbss_"+str(lbss)
    suff = "_"+addon+appendtxt
    newname = newname+"_"+addon+appendtxt+".dmb"
#Find the reference frame number for the TIFF file suffix
    refindx = f.find("ref",0,len(f))
    refindx -= 1
    refnum = f[refindx:indx]
#------------------------------------------------------------------------------------
#Change the values that were assigned at the beginning of this script
#User should comment out the values that are not to be changed and uncomment those to
#Be changed
    pick['frame_strip_ncc_threshold']               = thresh
##    pick['min_overlap_for_cropping_strip_image']    = overlap
##    pick['frame_strip_lines_between_strips_start']  = lbss
##    pick['frame_strip_lines_per_strip']             = lps
##    pick['frame_strip_ncc_n_columns_to_ignore']     = NCCcols
##    pick['frame_strip_ncc_n_rows_to_ignore']        = NCCrows
    pick['user_defined_suffix']                     = refnum+suff
##    pick['save_strip_registered_image']             = True
##    pick['save_strip_registered_sequence']          = False
##    pick['save_full_frame_registered_image']        = True
##    pick['strip_max_displacement_threshold']        = maxdisplace
#-------------------------------------------------------------------------------------
#Open/create a new dmb file with the suffix containing the original reference
#frame and the lps and lbss numbers, then close the old and new file
    newfid = open(dmbpath+newname,'w')
    cPickle.dump(pick,newfid)
    newfid.close()








